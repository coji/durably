# 将来仕様: ジョブ定義の自動バージョン管理

> **⚠️ 注意: これは将来拡張の構想ドキュメントです。**
>
> 手動の `version` 記述を要求せず、Run と Job 定義の整合性を保つ。

## 目的

- ジョブの中身を更新しても、既存 Run と整合性が崩れないようにする
- ユーザーに手動のバージョン指定を強制しない

## 基本方針

Run は **作成時点の Job 定義に固定**される。  
定義の変更を検知するため、**自動生成した `job_hash`** を保存する。

## 仕組み（必要十分）

### 1. job_hash の生成

- `defineJob()` の入力から安定したハッシュを生成する
- 例: `name + input schema + output schema + run の識別子`
- 実装は **順序・空白の影響を受けない** ことが必須

### 2. Run への保存

- Run 作成時に `job_hash` を保存する
- 以降、その Run は同じ `job_hash` の定義でのみ再開可能

### 3. 再開時の整合性チェック

現在の `job_hash` と Run の `job_hash` が一致しない場合:

- **デフォルト:** 互換性なしとして `failed` 扱いにする
- **オプション:** `allowIncompatible: true` の明示で上書き可能

**HITL との整合（Phase 2）**
- Job Versioning 実装後に `waiting_human` の `resume()` にチェックを追加
- 不一致の場合は `job_version_mismatch` として失敗

---

## 互換性の扱い（最低限）

- 互換性の判断は **ハッシュ一致**のみ
- 明示的な「後方互換宣言」は Phase 2 で検討

---

## Open Questions

- `run` 関数をハッシュ化する方法（文字列化 / AST / 手動タグ）
- スキーマの安定化（Zod のシリアライズ形式）
- 互換性を許可する API の形
